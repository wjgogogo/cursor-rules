---
description: 
globs: *.js,*.jsx,*.ts,*.tsx
alwaysApply: false
---
# æ€§èƒ½ä¼˜åŒ–è§„èŒƒ

## æ ¸å¿ƒæŒ‡æ ‡ç›‘æ§ [P1]

ã€å¿…é¡»ã€‘ç›‘æ§ Web Vitals æ ¸å¿ƒæŒ‡æ ‡ï¼š

```tsx
import { getCLS, getFID, getLCP } from 'web-vitals';

// âœ… åŸºç¡€æ€§èƒ½ç›‘æ§
function sendToAnalytics(metric: any) {
  fetch('/api/performance', {
    method: 'POST',
    body: JSON.stringify({
      name: metric.name,
      value: metric.value,
      url: window.location.href,
    }),
  });
}

// ç›‘æ§æ ¸å¿ƒæŒ‡æ ‡
getCLS(sendToAnalytics);  // ç´¯ç§¯å¸ƒå±€åç§» < 0.1
getFID(sendToAnalytics);  // é¦–æ¬¡è¾“å…¥å»¶è¿Ÿ < 100ms
getLCP(sendToAnalytics);  // æœ€å¤§å†…å®¹ç»˜åˆ¶ < 2.5s
```

## å›¾ç‰‡ä¼˜åŒ–

ã€å¿…é¡»ã€‘ä¼˜åŒ–å›¾ç‰‡åŠ è½½ï¼š

```tsx
// âœ… æ­£ç¡® - å›¾ç‰‡æ‡’åŠ è½½
function LazyImage({ src, alt, ...props }: ImageProps) {
  const [isLoaded, setIsLoaded] = useState(false);
  const imgRef = useRef<HTMLImageElement>(null);

  useEffect(() => {
    const observer = new IntersectionObserver(
      ([entry]) => {
        if (entry.isIntersecting) {
          setIsLoaded(true);
          observer.disconnect();
        }
      },
      { threshold: 0.1 }
    );

    if (imgRef.current) {
      observer.observe(imgRef.current);
    }

    return () => observer.disconnect();
  }, []);

  return (
    <img
      ref={imgRef}
      src={isLoaded ? src : undefined}
      alt={alt}
      loading="lazy"
      {...props}
    />
  );
}

// âœ… æ­£ç¡® - å“åº”å¼å›¾ç‰‡æ ¼å¼
function ResponsiveImage({ src, alt }: { src: string; alt: string }) {
  return (
    <picture>
      <source srcSet={`${src}.webp`} type="image/webp" />
      <img src={`${src}.jpg`} alt={alt} loading="lazy" />
    </picture>
  );
}
```

## ä»£ç åˆ†å‰²

ã€å¿…é¡»ã€‘æŒ‰éœ€åŠ è½½ç»„ä»¶ï¼š

```tsx
import { lazy, Suspense } from 'react';

// âœ… æ­£ç¡® - è·¯ç”±çº§åˆ†å‰²
const Dashboard = lazy(() => import('./pages/Dashboard'));
const Profile = lazy(() => import('./pages/Profile'));
const Settings = lazy(() => import('./pages/Settings'));

function App() {
  return (
    <Suspense fallback={<div>åŠ è½½ä¸­...</div>}>
      <Routes>
        <Route path="/dashboard" element={<Dashboard />} />
        <Route path="/profile" element={<Profile />} />
        <Route path="/settings" element={<Settings />} />
      </Routes>
    </Suspense>
  );
}

// âœ… æ­£ç¡® - ç»„ä»¶çº§åˆ†å‰²
const HeavyChart = lazy(() => import('./HeavyChart'));

function DashboardPage() {
  return (
    <div>
      <h1>ä»ªè¡¨æ¿</h1>
      <Suspense fallback={<div>åŠ è½½å›¾è¡¨...</div>}>
        <HeavyChart />
      </Suspense>
    </div>
  );
}
```

## Bundle ä¼˜åŒ–

ã€å¿…é¡»ã€‘ä¼˜åŒ–æ‰“åŒ…ä½“ç§¯ï¼š

```tsx
// âœ… æ­£ç¡® - æŒ‰éœ€å¯¼å…¥
import { debounce, throttle } from 'lodash-es';
import { format, parseISO } from 'date-fns';

// âŒ é”™è¯¯ - å¯¼å…¥æ•´ä¸ªåº“
import _ from 'lodash';
import moment from 'moment';

// âœ… æ­£ç¡® - åŠ¨æ€å¯¼å…¥é‡å‹åº“
async function loadChart() {
  const { Chart } = await import('chart.js');
  return Chart;
}

// âœ… æ­£ç¡® - Tree Shaking é…ç½®
// package.json
{
  "sideEffects": false, // å¯ç”¨ tree shaking
  "type": "module"
}
```

## React æ¸²æŸ“ä¼˜åŒ–

ã€å¿…é¡»ã€‘åˆç†ä½¿ç”¨ React ä¼˜åŒ–ï¼š

```tsx
// âœ… æ­£ç¡® - React.memo
const UserCard = React.memo(function UserCard({ user, onEdit }: UserCardProps) {
  return (
    <div>
      <h3>{user.name}</h3>
      <button onClick={() => onEdit(user)}>ç¼–è¾‘</button>
    </div>
  );
});

// âœ… æ­£ç¡® - useMemo ç¼“å­˜è®¡ç®—ç»“æœ
function UserList({ users }: { users: User[] }) {
  const sortedUsers = useMemo(() => {
    return users.sort((a, b) => a.name.localeCompare(b.name));
  }, [users]);

  return (
    <div>
      {sortedUsers.map(user => (
        <UserCard key={user.id} user={user} />
      ))}
    </div>
  );
}

// âœ… æ­£ç¡® - useCallback ç¼“å­˜å‡½æ•°
function TodoList({ todos, onToggle }: TodoListProps) {
  const handleToggle = useCallback((id: string) => {
    onToggle(id);
  }, [onToggle]);

  return (
    <div>
      {todos.map(todo => (
        <TodoItem key={todo.id} todo={todo} onToggle={handleToggle} />
      ))}
    </div>
  );
}
```

## ç”¨æˆ·äº¤äº’ä¼˜åŒ–

ã€å¿…é¡»ã€‘å®ç°é˜²æŠ–å’ŒèŠ‚æµï¼š

```tsx
// âœ… æ­£ç¡® - é˜²æŠ– Hook
function useDebounce<T>(value: T, delay: number): T {
  const [debouncedValue, setDebouncedValue] = useState<T>(value);

  useEffect(() => {
    const handler = setTimeout(() => {
      setDebouncedValue(value);
    }, delay);

    return () => clearTimeout(handler);
  }, [value, delay]);

  return debouncedValue;
}

// âœ… æ­£ç¡® - æœç´¢é˜²æŠ–
function SearchInput({ onSearch }: { onSearch: (query: string) => void }) {
  const [query, setQuery] = useState('');
  const debouncedQuery = useDebounce(query, 300);

  useEffect(() => {
    if (debouncedQuery) {
      onSearch(debouncedQuery);
    }
  }, [debouncedQuery, onSearch]);

  return (
    <input
      value={query}
      onChange={(e) => setQuery(e.target.value)}
      placeholder="æœç´¢..."
    />
  );
}

// âœ… æ­£ç¡® - èŠ‚æµ Hook  
function useThrottle<T>(value: T, delay: number): T {
  const [throttledValue, setThrottledValue] = useState<T>(value);
  const lastRan = useRef(Date.now());

  useEffect(() => {
    const handler = setTimeout(() => {
      if (Date.now() - lastRan.current >= delay) {
        setThrottledValue(value);
        lastRan.current = Date.now();
      }
    }, delay - (Date.now() - lastRan.current));

    return () => clearTimeout(handler);
  }, [value, delay]);

  return throttledValue;
}
```

## ç¼“å­˜ç­–ç•¥

ã€æ¨èã€‘å®ç°åŸºç¡€ç¼“å­˜ï¼š

```tsx
// âœ… æ­£ç¡® - React Query ç¼“å­˜
import { useQuery } from '@tanstack/react-query';

function useUserData(userId: string) {
  return useQuery({
    queryKey: ['user', userId],
    queryFn: () => fetchUser(userId),
    staleTime: 5 * 60 * 1000, // 5åˆ†é’Ÿç¼“å­˜
    cacheTime: 10 * 60 * 1000, // 10åˆ†é’Ÿåæ¸…é™¤
  });
}

// âœ… æ­£ç¡® - å†…å­˜ç¼“å­˜
const cache = new Map<string, { data: any; timestamp: number }>();

function getCachedData(key: string, ttl: number = 300000) {
  const cached = cache.get(key);
  if (cached && Date.now() - cached.timestamp < ttl) {
    return cached.data;
  }
  return null;
}

function setCachedData(key: string, data: any) {
  cache.set(key, { data, timestamp: Date.now() });
}
```

## å†…å­˜æ³„æ¼é˜²æŠ¤

ã€å¿…é¡»ã€‘æ¸…ç†å‰¯ä½œç”¨ï¼š

```tsx
// âœ… æ­£ç¡® - æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
function WindowSizeTracker() {
  const [size, setSize] = useState({ width: 0, height: 0 });

  useEffect(() => {
    function handleResize() {
      setSize({
        width: window.innerWidth,
        height: window.innerHeight,
      });
    }

    window.addEventListener('resize', handleResize);
    
    return () => {
      window.removeEventListener('resize', handleResize);
    };
  }, []);

  return <div>{size.width} x {size.height}</div>;
}

// âœ… æ­£ç¡® - æ¸…ç†å®šæ—¶å™¨
function Timer() {
  const [count, setCount] = useState(0);

  useEffect(() => {
    const interval = setInterval(() => {
      setCount(prev => prev + 1);
    }, 1000);

    return () => clearInterval(interval);
  }, []);

  return <div>è®¡æ•°: {count}</div>;
}
```

## è™šæ‹Ÿæ»šåŠ¨

ã€æ¨èã€‘å¤„ç†å¤§é‡æ•°æ®ï¼š

```tsx
import { FixedSizeList as List } from 'react-window';

// âœ… æ­£ç¡® - è™šæ‹Ÿæ»šåŠ¨
function VirtualizedList({ items }: { items: any[] }) {
  const Row = ({ index, style }: { index: number; style: React.CSSProperties }) => (
    <div style={style}>
      <UserCard user={items[index]} />
    </div>
  );

  return (
    <List
      height={600}
      itemCount={items.length}
      itemSize={80}
      width="100%"
    >
      {Row}
    </List>
  );
}
```

## ğŸ” æ£€æŸ¥æ¸…å•

åœ¨è¿›è¡Œæ€§èƒ½ä¼˜åŒ–å·¥ä½œæˆ–ä»£ç å®¡æŸ¥æ—¶ï¼Œè¯·å¯¹ç…§ä»¥ä¸‹æ£€æŸ¥é¡¹ï¼š

### React ä¸æ¸²æŸ“ä¼˜åŒ– [P0]
- [ ] **[P0]** ç»„ä»¶æ¸²æŸ“ä¼˜åŒ–ï¼šæ˜¯å¦åˆç†ä½¿ç”¨ `React.memo` æ¥åŒ…è£¹ä¸å¸¸å˜åŒ–çš„ç»„ä»¶ï¼Ÿå¯¹äºå¤æ‚è®¡ç®—æˆ–å¯¹è±¡/æ•°ç»„ä¾èµ–ï¼Œæ˜¯å¦ä½¿ç”¨ `useMemo` è¿›è¡Œç¼“å­˜ï¼Ÿå¯¹äºä¼ é€’ç»™å­ç»„ä»¶çš„å›è°ƒå‡½æ•°ï¼Œæ˜¯å¦ä½¿ç”¨ `useCallback` æ¥ç¨³å®šå…¶å¼•ç”¨ï¼Ÿ
- [ ] **[P0]** ä»£ç åˆ†å‰² (è·¯ç”±/ç»„ä»¶çº§)ï¼šæ˜¯å¦å¯¹å¤§å‹é¡µé¢æˆ–éé¦–å±ç»„ä»¶ä½¿ç”¨äº† `React.lazy` å’Œ `Suspense` è¿›è¡Œä»£ç åˆ†å‰²ï¼Œä»¥å‡å°‘åˆå§‹åŠ è½½ä½“ç§¯ï¼Ÿ
- [ ] **[P0]** è™šæ‹ŸåŒ–åˆ—è¡¨ï¼šå¯¹äºéœ€è¦æ¸²æŸ“å¤§é‡æ•°æ®é¡¹çš„é•¿åˆ—è¡¨ï¼Œæ˜¯å¦ä½¿ç”¨äº†è™šæ‹ŸåŒ–æŠ€æœ¯ï¼ˆå¦‚ `react-window` æˆ– `react-virtualized`ï¼‰æ¥ä¼˜åŒ–æ¸²æŸ“æ€§èƒ½å’Œå†…å­˜å ç”¨ï¼Ÿ

### èµ„æºä¸åŠ è½½ä¼˜åŒ– [P0]
- [ ] **[P0]** å›¾ç‰‡ä¼˜åŒ–ï¼šé¡¹ç›®ä¸­ä½¿ç”¨çš„å›¾ç‰‡æ˜¯å¦ç»è¿‡å‹ç¼©ï¼Ÿæ˜¯å¦ä¸ºä¸»è¦å›¾ç‰‡æ ¼å¼æä¾›äº†ç°ä»£æ ¼å¼ï¼ˆå¦‚ WebPï¼‰å¹¶é€šè¿‡ `<picture>` å…ƒç´ æˆ–å†…å®¹åå•†æä¾›ï¼Ÿ
- [ ] **[P0]** èµ„æºæ‡’åŠ è½½ï¼šå¯¹äºéé¦–å±æˆ–éå…³é”®çš„å›¾ç‰‡ã€iframeã€è§†é¢‘ç­‰èµ„æºï¼Œæ˜¯å¦å®ç°äº†æ‡’åŠ è½½ï¼ˆIntersection Observer API æˆ– `loading="lazy"` å±æ€§ï¼‰ï¼Ÿ
- [ ] **[P0]** Bundle ä½“ç§¯ä¼˜åŒ–ï¼š
    - æ˜¯å¦å®è·µäº†æŒ‰éœ€å¯¼å…¥ï¼ˆå¦‚ `import { specificFunction } from 'library'` è€Œé `import _ from 'library'`ï¼‰ï¼Ÿ
    - é¡¹ç›® `package.json` åŠæ„å»ºé…ç½®æ˜¯å¦æ”¯æŒå¹¶æ­£ç¡®åˆ©ç”¨äº† Tree Shaking (å¦‚è®¾ç½® `sideEffects: false`)ï¼Ÿ
    - æ˜¯å¦é¿å…äº†ä¸å¿…è¦çš„ç¬¬ä¸‰æ–¹åº“ä¾èµ–æˆ–å¯»æ‰¾è½»é‡çº§æ›¿ä»£å“ï¼Ÿ

### ç”¨æˆ·ä½“éªŒä¸äº¤äº’ä¼˜åŒ– [P0]
- [ ] **[P0]** é˜²æŠ– (Debounce)ï¼šå¯¹äºé¢‘ç¹è§¦å‘çš„äº‹ä»¶ï¼ˆå¦‚æœç´¢æ¡†è¾“å…¥ã€çª—å£ resizeï¼‰ï¼Œæ˜¯å¦å¯¹ç›¸åº”çš„å¤„ç†å‡½æ•°ä½¿ç”¨äº†é˜²æŠ–ï¼ˆDebounceï¼‰ä»¥é¿å…ä¸å¿…è¦çš„è®¡ç®—å’Œ API è¯·æ±‚ï¼Ÿ
- [ ] **[P0]** èŠ‚æµ (Throttle)ï¼šå¯¹äºè¿ç»­è§¦å‘çš„äº‹ä»¶ï¼ˆå¦‚æ»šåŠ¨ã€é¼ æ ‡ç§»åŠ¨ï¼‰ï¼Œå¦‚æœéœ€è¦åœ¨å›ºå®šæ—¶é—´é—´éš”å†…å“åº”ï¼Œæ˜¯å¦å¯¹å¤„ç†å‡½æ•°ä½¿ç”¨äº†èŠ‚æµï¼ˆThrottleï¼‰ï¼Ÿ

### ç›‘æ§ä¸åˆ†æ [P1]
- [ ] **[P1]** Web Vitals æ ¸å¿ƒæŒ‡æ ‡ç›‘æ§ï¼šé¡¹ç›®ä¸­æ˜¯å¦é›†æˆäº† Web Vitals (LCP, FID, CLS) çš„ç›‘æ§ï¼Œå¹¶å®šæœŸåˆ†ææ•°æ®ä»¥è¯†åˆ«æ€§èƒ½ç“¶é¢ˆï¼Ÿ
- [ ] **[P1]** Bundle åˆ†æå·¥å…·ï¼šæ˜¯å¦å®šæœŸä½¿ç”¨ Bundle åˆ†æå·¥å…·ï¼ˆå¦‚ `vite-plugin-inspect`, `webpack-bundle-analyzer`, `source-map-explorer`ï¼‰æ£€æŸ¥æ‰“åŒ…äº§ç‰©ï¼Œè¯†åˆ«å¹¶ä¼˜åŒ–ä½“ç§¯è¿‡å¤§çš„æ¨¡å—ï¼Ÿ

### è¿›é˜¶ä¸æ¶æ„ä¼˜åŒ– [P2]
- [ ] **[P2]** CDN ä½¿ç”¨ï¼šé¡¹ç›®çš„é™æ€èµ„æºï¼ˆå¦‚ JS, CSS, å›¾ç‰‡, å­—ä½“ï¼‰æ˜¯å¦é€šè¿‡ CDN (Content Delivery Network) æä¾›ä»¥åŠ é€Ÿå…¨çƒè®¿é—®é€Ÿåº¦ï¼Ÿ
- [ ] **[P2]** æœåŠ¡ç«¯æ¸²æŸ“ (SSR) / é™æ€ç«™ç‚¹ç”Ÿæˆ (SSG)ï¼šå¯¹äºå†…å®¹å‹ç½‘ç«™æˆ–éœ€è¦æè‡´é¦–å±æ€§èƒ½çš„åº”ç”¨ï¼Œæ˜¯å¦è¯„ä¼°æˆ–é‡‡ç”¨äº† SSR/SSG æ–¹æ¡ˆï¼Ÿ
- [ ] **[P2]** Web Workersï¼šå¯¹äº CPU å¯†é›†å‹æˆ–é•¿æ—¶é—´è¿è¡Œçš„è®¡ç®—ä»»åŠ¡ï¼Œæ˜¯å¦è€ƒè™‘ä½¿ç”¨ Web Workers å°†å…¶ç§»å‡ºä¸»çº¿ç¨‹ä»¥é¿å…é˜»å¡ UIï¼Ÿ
- [ ] **[P2]** æ•°æ®ç¼“å­˜ç­–ç•¥ï¼šå¯¹äºä¸å¸¸å˜åŒ–ä½†é¢‘ç¹è¯·æ±‚çš„æ•°æ®ï¼Œæ˜¯å¦åœ¨å®¢æˆ·ç«¯æˆ–æœåŠ¡ç«¯ï¼ˆå¦‚ä½¿ç”¨ Redis, Memcachedï¼‰å®æ–½äº†æœ‰æ•ˆçš„ç¼“å­˜ç­–ç•¥ï¼Ÿ

