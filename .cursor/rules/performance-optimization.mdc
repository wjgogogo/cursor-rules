---
description: 
globs: *.js,*.jsx,*.ts,*.tsx
alwaysApply: false
---
# 性能优化规范

## Suspense 和错误边界

【必须】为客户端组件提供 fallback：

```tsx
// ✅ 正确
function App() {
  return (
    <Suspense fallback={<LoadingSpinner />}>
      <UserDashboard />
    </Suspense>
  );
}

function LoadingSpinner() {
  return (
    <div className="flex items-center justify-center p-4">
      <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
    </div>
  );
}
```

## 动态加载

【必须】对非关键组件使用懒加载：

```tsx
// ✅ 正确
import { lazy, Suspense } from 'react';

const HeavyChart = lazy(() => import('./HeavyChart'));

function Dashboard() {
  return (
    <div>
      <h1>仪表板</h1>
      <Suspense fallback={<div>加载图表中...</div>}>
        <HeavyChart />
      </Suspense>
    </div>
  );
}
```

## 内存优化

【必须】清理副作用，防止内存泄漏：

```tsx
// ✅ 正确
function WindowSizeTracker() {
  const [windowSize, setWindowSize] = useState({ width: 0, height: 0 });

  useEffect(() => {
    function handleResize() {
      setWindowSize({
        width: window.innerWidth,
        height: window.innerHeight,
      });
    }

    window.addEventListener('resize', handleResize);
    
    // 清理函数防止内存泄漏
    return () => {
      window.removeEventListener('resize', handleResize);
    };
  }, []);

  return <div>{windowSize.width} x {windowSize.height}</div>;
}

// ❌ 错误 - 未清理定时器
function BadTimer() {
  const [count, setCount] = useState(0);

  useEffect(() => {
    setInterval(() => { // 内存泄漏
      setCount(prev => prev + 1);
    }, 1000);
  }, []);

  return <div>计数: {count}</div>;
}
```

## 渲染优化

【必须】合理使用优化 Hooks：

```tsx
// ✅ 正确 - React.memo
const UserCard = React.memo(function UserCard({ user, onEdit }: UserCardProps) {
  return (
    <div className="card">
      <h3>{user.name}</h3>
      <button onClick={() => onEdit(user)}>编辑</button>
    </div>
  );
});

// ✅ 正确 - useMemo 和 useCallback
function UserList({ users, onUserEdit }: { users: User[]; onUserEdit: (user: User) => void }) {
  const sortedUsers = useMemo(() => {
    return users.sort((a, b) => a.name.localeCompare(b.name));
  }, [users]);

  const handleUserEdit = useCallback((user: User) => {
    onUserEdit(user);
  }, [onUserEdit]);

  return (
    <div>
      {sortedUsers.map(user => (
        <UserCard key={user.id} user={user} onEdit={handleUserEdit} />
      ))}
    </div>
  );
}
```

## 网络优化

【必须】实现请求去重：

```tsx
// ✅ 正确
const requestCache = new Map<string, Promise<any>>();

function fetchWithDeduplication<T>(url: string): Promise<T> {
  if (requestCache.has(url)) {
    return requestCache.get(url)!;
  }

  const promise = fetch(url)
    .then(response => response.json())
    .finally(() => {
      requestCache.delete(url);
    });

  requestCache.set(url, promise);
  return promise;
}
```

## 用户交互优化

【必须】实现防抖：

```tsx
// ✅ 正确 - 防抖 Hook
function useDebounce<T>(value: T, delay: number): T {
  const [debouncedValue, setDebouncedValue] = useState<T>(value);

  useEffect(() => {
    const handler = setTimeout(() => {
      setDebouncedValue(value);
    }, delay);

    return () => clearTimeout(handler);
  }, [value, delay]);

  return debouncedValue;
}

// ✅ 正确 - 搜索防抖
function SearchInput({ onSearch }: { onSearch: (query: string) => void }) {
  const [query, setQuery] = useState('');
  const debouncedQuery = useDebounce(query, 300);

  useEffect(() => {
    if (debouncedQuery) {
      onSearch(debouncedQuery);
    }
  }, [debouncedQuery, onSearch]);

  return (
    <input
      type="text"
      value={query}
      onChange={(e) => setQuery(e.target.value)}
      placeholder="搜索..."
      className="w-full p-2 border rounded"
    />
  );
}
```

## 代码分割

【必须】按路由分割：

```tsx
// ✅ 正确
import { lazy } from 'react';
import { Routes, Route } from 'react-router-dom';

const Home = lazy(() => import('./pages/Home'));
const Profile = lazy(() => import('./pages/Profile'));
const Settings = lazy(() => import('./pages/Settings'));

function App() {
  return (
    <Suspense fallback={<div>加载中...</div>}>
      <Routes>
        <Route path="/" element={<Home />} />
        <Route path="/profile" element={<Profile />} />
        <Route path="/settings" element={<Settings />} />
      </Routes>
    </Suspense>
  );
}

// ✅ 正确示例 - 按需导入工具库
// 好的做法：只导入需要的函数
import { debounce, throttle } from 'lodash-es';

// ❌ 错误示例：导入整个库
import _ from 'lodash'; // 这会导入整个 lodash 库
```
