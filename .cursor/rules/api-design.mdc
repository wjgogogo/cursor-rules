---
description: 
globs: 
alwaysApply: false
---
# API è®¾è®¡è§„èŒƒ

## RESTful API è®¾è®¡åŸåˆ™

ã€å¿…é¡»ã€‘éµå¾ª REST æ¶æ„é£æ ¼ï¼š

```typescript
// âœ… æ­£ç¡® - RESTful è·¯ç”±è®¾è®¡
interface ApiRoutes {
  'GET /api/users': { response: PaginatedResponse<User> };
  'GET /api/users/:id': { params: { id: string }; response: ApiResponse<User> };
  'POST /api/users': { body: CreateUserRequest; response: ApiResponse<User> };
  'PUT /api/users/:id': { params: { id: string }; body: UpdateUserRequest; response: ApiResponse<User> };
  'DELETE /api/users/:id': { params: { id: string }; response: ApiResponse<null> };
}

// âœ… æ­£ç¡® - HTTP æ–¹æ³•ä½¿ç”¨
const HTTP_METHODS = {
  GET: 'è·å–èµ„æºï¼Œå¹‚ç­‰ï¼Œæ— å‰¯ä½œç”¨',
  POST: 'åˆ›å»ºèµ„æºæˆ–æ‰§è¡Œæ“ä½œ',
  PUT: 'å®Œæ•´æ›´æ–°èµ„æºï¼Œå¹‚ç­‰',
  PATCH: 'éƒ¨åˆ†æ›´æ–°èµ„æºï¼Œå¹‚ç­‰',
  DELETE: 'åˆ é™¤èµ„æºï¼Œå¹‚ç­‰',
} as const;
```

## ç»Ÿä¸€å“åº”æ ¼å¼

ã€å¿…é¡»ã€‘ä½¿ç”¨ä¸€è‡´çš„å“åº”ç»“æ„ï¼š

```typescript
// âœ… æ­£ç¡® - åŸºç¡€å“åº”æ ¼å¼
interface ApiResponse<T = any> {
  success: boolean;
  data: T;
  message: string;
  timestamp: string;
}

// âœ… æ­£ç¡® - åˆ†é¡µå“åº”æ ¼å¼
interface PaginatedResponse<T> extends ApiResponse<T[]> {
  pagination: {
    page: number;
    limit: number;
    total: number;
    hasNext: boolean;
    hasPrev: boolean;
  };
}

// âœ… æ­£ç¡® - é”™è¯¯å“åº”æ ¼å¼
interface ErrorResponse {
  success: false;
  error: {
    code: string;
    message: string;
    field?: string; // éªŒè¯é”™è¯¯æ—¶çš„å­—æ®µå
  };
  timestamp: string;
}

// âœ… æ­£ç¡® - å“åº”æ„å»ºå™¨
const createResponse = {
  success: <T>(data: T, message = 'Success'): ApiResponse<T> => ({
    success: true,
    data,
    message,
    timestamp: new Date().toISOString(),
  }),
  
  error: (code: string, message: string, field?: string): ErrorResponse => ({
    success: false,
    error: { code, message, field },
    timestamp: new Date().toISOString(),
  }),
};
```

## HTTP çŠ¶æ€ç è§„èŒƒ

ã€å¿…é¡»ã€‘æ­£ç¡®ä½¿ç”¨å¸¸ç”¨çŠ¶æ€ç ï¼š

```typescript
const HTTP_STATUS = {
  // æˆåŠŸ
  200: 'OK - è¯·æ±‚æˆåŠŸ',
  201: 'Created - èµ„æºåˆ›å»ºæˆåŠŸ', 
  204: 'No Content - åˆ é™¤æˆåŠŸ',
  
  // å®¢æˆ·ç«¯é”™è¯¯
  400: 'Bad Request - è¯·æ±‚å‚æ•°é”™è¯¯',
  401: 'Unauthorized - æœªè®¤è¯',
  403: 'Forbidden - æ— æƒé™',
  404: 'Not Found - èµ„æºä¸å­˜åœ¨',
  422: 'Unprocessable Entity - éªŒè¯å¤±è´¥',
  
  // æœåŠ¡å™¨é”™è¯¯
  500: 'Internal Server Error - æœåŠ¡å™¨é”™è¯¯',
} as const;

// âœ… ä½¿ç”¨ç¤ºä¾‹
app.get('/api/users/:id', async (req, res) => {
  const user = await userService.findById(req.params.id);
  if (!user) {
    return res.status(404).json(
      createResponse.error('USER_NOT_FOUND', 'ç”¨æˆ·ä¸å­˜åœ¨')
    );
  }
  res.status(200).json(createResponse.success(user));
});
```

## è¯·æ±‚éªŒè¯

ã€å¿…é¡»ã€‘éªŒè¯æ‰€æœ‰è¾“å…¥æ•°æ®ï¼š

```typescript
import { z } from 'zod';

// âœ… æ­£ç¡® - å®šä¹‰éªŒè¯æ¨¡å¼
const CreateUserSchema = z.object({
  name: z.string().min(1).max(100),
  email: z.string().email(),
  role: z.enum(['admin', 'user']).default('user'),
});

const PaginationSchema = z.object({
  page: z.coerce.number().int().min(1).default(1),
  limit: z.coerce.number().int().min(1).max(100).default(20),
});

// âœ… æ­£ç¡® - éªŒè¯ä¸­é—´ä»¶
function validateBody<T extends z.ZodSchema>(schema: T) {
  return (req: Request, res: Response, next: NextFunction) => {
    try {
      req.body = schema.parse(req.body);
      next();
    } catch (error) {
      if (error instanceof z.ZodError) {
        return res.status(422).json(
          createResponse.error('VALIDATION_ERROR', 'æ•°æ®éªŒè¯å¤±è´¥')
        );
      }
      next(error);
    }
  };
}

// âœ… ä½¿ç”¨ç¤ºä¾‹
app.post('/api/users', 
  validateBody(CreateUserSchema),
  async (req, res) => {
    const user = await userService.create(req.body);
    res.status(201).json(createResponse.success(user));
  }
);
```

## é”™è¯¯ç è§„èŒƒ

ã€å¿…é¡»ã€‘ä½¿ç”¨ç»Ÿä¸€çš„é”™è¯¯ç ï¼š

```typescript
const ERROR_CODES = {
  // é€šç”¨é”™è¯¯
  INTERNAL_ERROR: 'E1000',
  INVALID_REQUEST: 'E1001', 
  UNAUTHORIZED: 'E1002',
  FORBIDDEN: 'E1003',
  NOT_FOUND: 'E1004',
  
  // éªŒè¯é”™è¯¯
  VALIDATION_ERROR: 'E2000',
  INVALID_EMAIL: 'E2001',
  
  // ä¸šåŠ¡é”™è¯¯
  USER_NOT_FOUND: 'E3000',
  USER_ALREADY_EXISTS: 'E3001',
  INVALID_CREDENTIALS: 'E3002',
} as const;

// âœ… å…¨å±€é”™è¯¯å¤„ç†
function errorHandler(err: Error, req: Request, res: Response, next: NextFunction) {
  console.error('API Error:', err);
  
  // æ ¹æ®é”™è¯¯ç±»å‹è¿”å›é€‚å½“çš„çŠ¶æ€ç å’Œæ¶ˆæ¯
  if (err.message.includes('not found')) {
    return res.status(404).json(
      createResponse.error(ERROR_CODES.NOT_FOUND, 'èµ„æºä¸å­˜åœ¨')
    );
  }
  
  res.status(500).json(
    createResponse.error(ERROR_CODES.INTERNAL_ERROR, 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯')
  );
}
```

## API ç‰ˆæœ¬æ§åˆ¶

ã€æ¨èã€‘ä½¿ç”¨ URL ç‰ˆæœ¬æ§åˆ¶ï¼š

```typescript
// âœ… æ­£ç¡® - URL ç‰ˆæœ¬æ§åˆ¶
app.get('/api/v1/users/:id', userController.getUserV1);
app.get('/api/v2/users/:id', userController.getUserV2);

// âœ… ç‰ˆæœ¬å…¼å®¹å¤„ç†
interface UserV1 {
  id: string;
  name: string;
  email: string;
}

interface UserV2 extends UserV1 {
  profile: {
    avatar: string;
    bio: string;
  };
}
```

## å®‰å…¨å’Œæ€§èƒ½

ã€å¿…é¡»ã€‘å®ç°åŸºç¡€å®‰å…¨æªæ–½ï¼š

```typescript
// âœ… è®¤è¯ä¸­é—´ä»¶
function authenticate(req: Request, res: Response, next: NextFunction) {
  const token = req.headers.authorization?.replace('Bearer ', '');
  if (!token) {
    return res.status(401).json(
      createResponse.error(ERROR_CODES.UNAUTHORIZED, 'ç¼ºå°‘è®¤è¯ä»¤ç‰Œ')
    );
  }
  // éªŒè¯ token é€»è¾‘
  next();
}

// âœ… åŸºç¡€é€Ÿç‡é™åˆ¶
import rateLimit from 'express-rate-limit';

const apiLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 åˆ†é’Ÿ
  max: 100, // æœ€å¤š 100 ä¸ªè¯·æ±‚
  message: createResponse.error('RATE_LIMITED', 'è¯·æ±‚è¿‡äºé¢‘ç¹'),
});

app.use('/api/', apiLimiter);
```

## ğŸ” æ£€æŸ¥æ¸…å•

### API è®¾è®¡æ ¸å¿ƒ [P0]
- [ ] **[P0]** RESTful è®¾è®¡ï¼šéµå¾ªèµ„æºå¯¼å‘åŸåˆ™ï¼Œæ­£ç¡®ä½¿ç”¨ HTTP æ–¹æ³• (GET, POST, PUT, DELETE)ï¼Ÿ
- [ ] **[P0]** ç»Ÿä¸€å“åº”ï¼šæ‰€æœ‰ API å“åº”æ˜¯å¦éµå¾ªç»Ÿä¸€çš„æˆåŠŸå’Œé”™è¯¯æ ¼å¼ (e.g., `success`, `data`, `error`, `message`, `timestamp`)ï¼Ÿ
- [ ] **[P0]** HTTP çŠ¶æ€ç ï¼šæ˜¯å¦æ ¹æ®æ“ä½œç»“æœæ­£ç¡®ä½¿ç”¨ HTTP çŠ¶æ€ç  (2xx, 4xx, 5xx)ï¼Ÿ
- [ ] **[P0]** è¾“å…¥éªŒè¯ï¼šæ‰€æœ‰æ¥è‡ªå®¢æˆ·ç«¯çš„è¾“å…¥ï¼ˆbody, query, paramsï¼‰æ˜¯å¦éƒ½ç»è¿‡ä¸¥æ ¼éªŒè¯ (e.g.,ä½¿ç”¨ Zod)ï¼Ÿ
- [ ] **[P0]** é”™è¯¯å¤„ç†ï¼šæ˜¯å¦å®šä¹‰å¹¶ä½¿ç”¨ç»Ÿä¸€çš„é”™è¯¯ç è§„èŒƒï¼Œå¹¶åœ¨é”™è¯¯å‘ç”Ÿæ—¶è¿”å›ç»“æ„åŒ–çš„é”™è¯¯ä¿¡æ¯ï¼Ÿ
- [ ] **[P0]** å®‰å…¨åŸºç¡€ï¼šæ˜¯å¦å·²å®æ–½å¿…è¦çš„è®¤è¯å’Œæˆæƒæœºåˆ¶ä¿æŠ¤ API ç«¯ç‚¹ï¼Ÿ

### API è´¨é‡ä¸å¯ç»´æŠ¤æ€§ [P1]
- [ ] **[P1]** åˆ†é¡µå®ç°ï¼šå¯¹äºåˆ—è¡¨ç±»å‹çš„å“åº”ï¼Œæ˜¯å¦æ­£ç¡®å®ç°åˆ†é¡µé€»è¾‘ (e.g., `page`, `limit`, `total`)ï¼Ÿ
- [ ] **[P1]** API ç‰ˆæœ¬æ§åˆ¶ï¼šå¦‚ API å‘ç”Ÿé‡å¤§å˜æ›´ï¼Œæ˜¯å¦æœ‰æ˜ç¡®çš„ç‰ˆæœ¬æ§åˆ¶ç­–ç•¥ (e.g., URL ç‰ˆæœ¬ `/api/v1/users`)ï¼Ÿ
- [ ] **[P1]** é€Ÿç‡é™åˆ¶ï¼šæ˜¯å¦å¯¹ API è¯·æ±‚å®æ–½äº†é€Ÿç‡é™åˆ¶ä»¥é˜²æ­¢æ»¥ç”¨ï¼Ÿ
- [ ] **[P1]** å¹‚ç­‰æ€§è€ƒè™‘ï¼šPOST, PUT, PATCH, DELETE ç­‰æ“ä½œæ˜¯å¦è€ƒè™‘äº†å¹‚ç­‰æ€§ï¼Ÿ
- [ ] **[P1]** æ–‡æ¡£å®Œæ•´ï¼šAPI æ˜¯å¦æœ‰å¯¹åº”çš„ã€æ›´æ–°åŠæ—¶çš„æ–‡æ¡£ (e.g., OpenAPI/Swagger)ï¼Ÿ

### æ€§èƒ½ä¸ç»†èŠ‚ [P2]
- [ ] **[P2]** ç¼“å­˜ç­–ç•¥ï¼šæ˜¯å¦ä¸ºå¯ç¼“å­˜çš„ GET è¯·æ±‚è®¾è®¡äº†åˆé€‚çš„ç¼“å­˜æœºåˆ¶ï¼Ÿ
- [ ] **[P2]** å­—æ®µé€‰æ‹©ï¼šæ˜¯å¦å…è®¸å®¢æˆ·ç«¯é€šè¿‡å‚æ•°é€‰æ‹©è¿”å›çš„å­—æ®µä»¥å‡å°‘æ•°æ®ä¼ è¾“ï¼Ÿ
- [ ] **[P2]** æ‰¹é‡æ“ä½œï¼šå¯¹äºéœ€è¦æ‰¹é‡å¤„ç†çš„åœºæ™¯ï¼Œæ˜¯å¦æä¾›äº†æ‰¹é‡æ“ä½œçš„ API ç«¯ç‚¹ï¼Ÿ
