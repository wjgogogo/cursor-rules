---
description: 
globs: 
alwaysApply: false
---
# æµ‹è¯•è§„èŒƒ

## æµ‹è¯•ç­–ç•¥ [P1]

ã€å¿…é¡»ã€‘éµå¾ªæµ‹è¯•é‡‘å­—å¡”åŸåˆ™ï¼š
- **å•å…ƒæµ‹è¯•ï¼ˆ70%ï¼‰**: æµ‹è¯•ç‹¬ç«‹å‡½æ•°å’Œç»„ä»¶
- **é›†æˆæµ‹è¯•ï¼ˆ20%ï¼‰**: æµ‹è¯•ç»„ä»¶é—´äº¤äº’
- **E2E æµ‹è¯•ï¼ˆ10%ï¼‰**: æµ‹è¯•å®Œæ•´ç”¨æˆ·æµç¨‹

## å•å…ƒæµ‹è¯•

ã€å¿…é¡»ã€‘ä½¿ç”¨ Vitest + Testing Libraryï¼š

```tsx
// âœ… æ­£ç¡® - ç»„ä»¶å•å…ƒæµ‹è¯•
import { render, screen, fireEvent } from '@testing-library/react';
import { describe, it, expect, vi } from 'vitest';
import { Button } from './Button';

describe('Button', () => {
  it('åº”è¯¥æ¸²æŸ“æŒ‰é’®æ–‡æœ¬', () => {
    render(<Button>ç‚¹å‡»æˆ‘</Button>);
    expect(screen.getByRole('button', { name: 'ç‚¹å‡»æˆ‘' })).toBeInTheDocument();
  });

  it('åº”è¯¥å¤„ç†ç‚¹å‡»äº‹ä»¶', () => {
    const handleClick = vi.fn();
    render(<Button onClick={handleClick}>ç‚¹å‡»æˆ‘</Button>);
    
    fireEvent.click(screen.getByRole('button'));
    expect(handleClick).toHaveBeenCalledTimes(1);
  });

  it('ç¦ç”¨çŠ¶æ€ä¸‹ä¸åº”è¯¥è§¦å‘ç‚¹å‡»', () => {
    const handleClick = vi.fn();
    render(<Button disabled onClick={handleClick}>ç‚¹å‡»æˆ‘</Button>);
    
    fireEvent.click(screen.getByRole('button'));
    expect(handleClick).not.toHaveBeenCalled();
  });
});

// âœ… æ­£ç¡® - Hook æµ‹è¯•
import { renderHook, act } from '@testing-library/react';
import { useCounter } from './useCounter';

describe('useCounter', () => {
  it('åº”è¯¥åˆå§‹åŒ–è®¡æ•°å™¨', () => {
    const { result } = renderHook(() => useCounter(0));
    expect(result.current.count).toBe(0);
  });

  it('åº”è¯¥å¢åŠ è®¡æ•°', () => {
    const { result } = renderHook(() => useCounter(0));
    
    act(() => {
      result.current.increment();
    });
    
    expect(result.current.count).toBe(1);
  });
});

// âœ… æ­£ç¡® - å·¥å…·å‡½æ•°æµ‹è¯•
import { formatCurrency, validateEmail } from './utils';

describe('utils', () => {
  describe('formatCurrency', () => {
    it('åº”è¯¥æ ¼å¼åŒ–è´§å¸', () => {
      expect(formatCurrency(1234.56)).toBe('Â¥1,234.56');
      expect(formatCurrency(0)).toBe('Â¥0.00');
    });
  });

  describe('validateEmail', () => {
    it('åº”è¯¥éªŒè¯æœ‰æ•ˆé‚®ç®±', () => {
      expect(validateEmail('test@example.com')).toBe(true);
      expect(validateEmail('invalid-email')).toBe(false);
    });
  });
});
```

## é›†æˆæµ‹è¯•

ã€å¿…é¡»ã€‘æµ‹è¯•ç»„ä»¶é—´äº¤äº’ï¼š

```tsx
// âœ… æ­£ç¡® - è¡¨å•é›†æˆæµ‹è¯•
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { UserForm } from './UserForm';

describe('UserForm é›†æˆæµ‹è¯•', () => {
  it('åº”è¯¥æäº¤æœ‰æ•ˆè¡¨å•', async () => {
    const user = userEvent.setup();
    const onSubmit = vi.fn();
    
    render(<UserForm onSubmit={onSubmit} />);
    
    // å¡«å†™è¡¨å•
    await user.type(screen.getByLabelText('å§“å'), 'å¼ ä¸‰');
    await user.type(screen.getByLabelText('é‚®ç®±'), 'zhangsan@example.com');
    
    // æäº¤è¡¨å•
    await user.click(screen.getByRole('button', { name: 'æäº¤' }));
    
    await waitFor(() => {
      expect(onSubmit).toHaveBeenCalledWith({
        name: 'å¼ ä¸‰',
        email: 'zhangsan@example.com',
      });
    });
  });

  it('åº”è¯¥æ˜¾ç¤ºéªŒè¯é”™è¯¯', async () => {
    const user = userEvent.setup();
    render(<UserForm onSubmit={vi.fn()} />);
    
    // æäº¤ç©ºè¡¨å•
    await user.click(screen.getByRole('button', { name: 'æäº¤' }));
    
    await waitFor(() => {
      expect(screen.getByText('å§“åæ˜¯å¿…å¡«é¡¹')).toBeInTheDocument();
      expect(screen.getByText('è¯·è¾“å…¥æœ‰æ•ˆé‚®ç®±')).toBeInTheDocument();
    });
  });
});
```

## E2E æµ‹è¯•

ã€å¿…é¡»ã€‘ä½¿ç”¨ Playwright æµ‹è¯•ç”¨æˆ·æµç¨‹ï¼š

```typescript
// âœ… æ­£ç¡® - E2E æµ‹è¯•
import { test, expect } from '@playwright/test';

test.describe('ç”¨æˆ·è®¤è¯æµç¨‹', () => {
  test('ç”¨æˆ·åº”è¯¥èƒ½å¤Ÿç™»å½•å’Œç™»å‡º', async ({ page }) => {
    // è®¿é—®ç™»å½•é¡µé¢
    await page.goto('/login');
    
    // å¡«å†™ç™»å½•è¡¨å•
    await page.fill('[data-testid="email"]', 'test@example.com');
    await page.fill('[data-testid="password"]', 'password123');
    await page.click('[data-testid="login-button"]');
    
    // éªŒè¯ç™»å½•æˆåŠŸ
    await expect(page).toHaveURL('/dashboard');
    await expect(page.locator('[data-testid="user-menu"]')).toBeVisible();
    
    // ç™»å‡º
    await page.click('[data-testid="user-menu"]');
    await page.click('[data-testid="logout-button"]');
    
    // éªŒè¯ç™»å‡ºæˆåŠŸ
    await expect(page).toHaveURL('/login');
  });

  test('åº”è¯¥æ˜¾ç¤ºç™»å½•é”™è¯¯', async ({ page }) => {
    await page.goto('/login');
    
    await page.fill('[data-testid="email"]', 'invalid@example.com');
    await page.fill('[data-testid="password"]', 'wrongpassword');
    await page.click('[data-testid="login-button"]');
    
    await expect(page.locator('[data-testid="error-message"]')).toContainText('ç™»å½•å¤±è´¥');
  });
});
```

## æµ‹è¯•é…ç½®

ã€å¿…é¡»ã€‘é…ç½®æµ‹è¯•ç¯å¢ƒï¼š

```typescript
// vitest.config.ts
import { defineConfig } from 'vitest/config';
import react from '@vitejs/plugin-react';

export default defineConfig({
  plugins: [react()],
  test: {
    environment: 'jsdom',
    setupFiles: ['./src/test/setup.ts'],
    globals: true,
    coverage: {
      provider: 'c8',
      reporter: ['text', 'json', 'html'],
      thresholds: {
        global: {
          branches: 80,
          functions: 80,
          lines: 80,
          statements: 80,
        },
      },
    },
  },
});
```

```typescript
// src/test/setup.ts
import '@testing-library/jest-dom';
import { cleanup } from '@testing-library/react';
import { afterEach, vi } from 'vitest';

// æ¯ä¸ªæµ‹è¯•åæ¸…ç†
afterEach(() => {
  cleanup();
});

// Mock å…¨å±€å¯¹è±¡
Object.defineProperty(window, 'matchMedia', {
  writable: true,
  value: vi.fn().mockImplementation(query => ({
    matches: false,
    media: query,
    onchange: null,
    addListener: vi.fn(),
    removeListener: vi.fn(),
    addEventListener: vi.fn(),
    removeEventListener: vi.fn(),
    dispatchEvent: vi.fn(),
  })),
});
```

```typescript
// playwright.config.ts
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: './e2e',
  fullyParallel: true,
  retries: process.env.CI ? 2 : 0,
  use: {
    baseURL: 'http://localhost:3000',
    trace: 'on-first-retry',
    screenshot: 'only-on-failure',
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
  ],
  webServer: {
    command: 'npm run dev',
    port: 3000,
    reuseExistingServer: !process.env.CI,
  },
});
```

## Mock ä½¿ç”¨

ã€å¿…é¡»ã€‘æ­£ç¡®ä½¿ç”¨ Mockï¼š

```typescript
// âœ… æ­£ç¡® - API Mock
import { vi } from 'vitest';

// Mock æ•´ä¸ªæ¨¡å—
vi.mock('./api/userService', () => ({
  UserService: {
    getUsers: vi.fn(),
    createUser: vi.fn(),
    updateUser: vi.fn(),
    deleteUser: vi.fn(),
  },
}));

// Mock fetch
const mockFetch = vi.fn();
global.fetch = mockFetch;

describe('API è°ƒç”¨', () => {
  beforeEach(() => {
    mockFetch.mockClear();
  });

  it('åº”è¯¥è°ƒç”¨æ­£ç¡®çš„ API', async () => {
    mockFetch.mockResolvedValueOnce({
      ok: true,
      json: async () => ({ id: '1', name: 'å¼ ä¸‰' }),
    });

    const user = await fetchUser('1');
    
    expect(mockFetch).toHaveBeenCalledWith('/api/users/1');
    expect(user.name).toBe('å¼ ä¸‰');
  });
});

// âœ… æ­£ç¡® - æ—¶é—´ Mock
describe('æ—¶é—´ç›¸å…³æµ‹è¯•', () => {
  beforeEach(() => {
    vi.useFakeTimers();
  });

  afterEach(() => {
    vi.useRealTimers();
  });

  it('åº”è¯¥åœ¨å»¶è¿Ÿåæ‰§è¡Œ', () => {
    const callback = vi.fn();
    setTimeout(callback, 1000);
    
    expect(callback).not.toHaveBeenCalled();
    
    vi.advanceTimersByTime(1000);
    expect(callback).toHaveBeenCalled();
  });
});
```

## æµ‹è¯•æ•°æ®ç®¡ç†

ã€æ¨èã€‘ä½¿ç”¨æµ‹è¯•å·¥å‚ï¼š

```typescript
// âœ… æ­£ç¡® - æµ‹è¯•å·¥å‚
import { faker } from '@faker-js/faker';

export const UserFactory = {
  build: (overrides: Partial<User> = {}): User => ({
    id: faker.string.uuid(),
    name: faker.person.fullName(),
    email: faker.internet.email(),
    createdAt: faker.date.recent(),
    ...overrides,
  }),

  buildList: (count: number, overrides: Partial<User> = {}): User[] =>
    Array.from({ length: count }, () => UserFactory.build(overrides)),
};

// ä½¿ç”¨ç¤ºä¾‹
describe('UserList', () => {
  it('åº”è¯¥æ˜¾ç¤ºç”¨æˆ·åˆ—è¡¨', () => {
    const users = UserFactory.buildList(3);
    render(<UserList users={users} />);
    
    users.forEach(user => {
      expect(screen.getByText(user.name)).toBeInTheDocument();
    });
  });
});
```

## æµ‹è¯•è¦†ç›–ç‡è¦æ±‚

ã€å¿…é¡»ã€‘è¾¾åˆ°ä»¥ä¸‹è¦†ç›–ç‡ï¼š
- **è¯­å¥è¦†ç›–ç‡**: â‰¥ 80%
- **åˆ†æ”¯è¦†ç›–ç‡**: â‰¥ 80%
- **å‡½æ•°è¦†ç›–ç‡**: â‰¥ 80%
- **è¡Œè¦†ç›–ç‡**: â‰¥ 80%

```json
// package.json è„šæœ¬
{
  "scripts": {
    "test": "vitest",
    "test:coverage": "vitest --coverage",
    "test:ui": "vitest --ui",
    "test:e2e": "playwright test"
  }
}
```

## æµ‹è¯•æœ€ä½³å®è·µ

ã€å¿…é¡»ã€‘éµå¾ªï¼š

### 1. æµ‹è¯•å‘½å
```typescript
// âœ… æ­£ç¡® - æè¿°æ€§æµ‹è¯•åç§°
describe('UserForm', () => {
  it('åº”è¯¥åœ¨æäº¤æœ‰æ•ˆæ•°æ®æ—¶è°ƒç”¨ onSubmit', () => {});
  it('åº”è¯¥åœ¨å§“åä¸ºç©ºæ—¶æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯', () => {});
  it('åº”è¯¥åœ¨é‚®ç®±æ ¼å¼æ— æ•ˆæ—¶æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯', () => {});
});

// âŒ é”™è¯¯ - æ¨¡ç³Šçš„æµ‹è¯•åç§°
describe('UserForm', () => {
  it('æµ‹è¯•æäº¤', () => {});
  it('æµ‹è¯•éªŒè¯', () => {});
});
```

### 2. æµ‹è¯•éš”ç¦»
```typescript
// âœ… æ­£ç¡® - æ¯ä¸ªæµ‹è¯•ç‹¬ç«‹
describe('Counter', () => {
  let counter: Counter;

  beforeEach(() => {
    counter = new Counter(0); // æ¯ä¸ªæµ‹è¯•éƒ½æœ‰æ–°å®ä¾‹
  });

  it('åº”è¯¥å¢åŠ è®¡æ•°', () => {
    counter.increment();
    expect(counter.value).toBe(1);
  });

  it('åº”è¯¥å‡å°‘è®¡æ•°', () => {
    counter.decrement();
    expect(counter.value).toBe(-1);
  });
});
```

### 3. æµ‹è¯•æ•°æ®
```typescript
// âœ… æ­£ç¡® - ä½¿ç”¨æœ‰æ„ä¹‰çš„æµ‹è¯•æ•°æ®
const validUser = {
  name: 'å¼ ä¸‰',
  email: 'zhangsan@example.com',
  age: 25,
};

const invalidUser = {
  name: '',
  email: 'invalid-email',
  age: -1,
};

// âŒ é”™è¯¯ - ä½¿ç”¨æ— æ„ä¹‰çš„æ•°æ®
const user = {
  name: 'test',
  email: 'test@test.com',
  age: 1,
};
```

## ğŸ” æ£€æŸ¥æ¸…å•

åœ¨ç¼–å†™ã€å®¡æŸ¥æˆ–ç»´æŠ¤æµ‹è¯•ä»£ç æ—¶ï¼Œè¯·å¯¹ç…§ä»¥ä¸‹æ£€æŸ¥é¡¹ï¼š

### æµ‹è¯•ç­–ç•¥ä¸è¦†ç›– [P0]
- [ ] **[P0]** æµ‹è¯•é‡‘å­—å¡”ï¼šé¡¹ç›®æ˜¯å¦éµå¾ªæµ‹è¯•é‡‘å­—å¡”åŸåˆ™ï¼Œåˆç†åˆ†é…å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•å’Œ E2E æµ‹è¯•çš„æ¯”ä¾‹ï¼Ÿ
- [ ] **[P0]** æ ¸å¿ƒåŠŸèƒ½è¦†ç›–ï¼šæ‰€æœ‰æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ã€å…³é”®ç»„ä»¶å’Œç”¨æˆ·æµç¨‹æ˜¯å¦éƒ½æœ‰ç›¸åº”çš„æµ‹è¯•è¦†ç›–ï¼Ÿ
- [ ] **[P0]** å•å…ƒæµ‹è¯•ï¼ˆç»„ä»¶ï¼‰ï¼šReact ç»„ä»¶æ˜¯å¦ä½¿ç”¨ `@testing-library/react` è¿›è¡Œæµ‹è¯•ï¼Œå…³æ³¨ç”¨æˆ·å¯è§çš„è¡Œä¸ºå’Œäº¤äº’ï¼Œè€Œéå†…éƒ¨å®ç°ç»†èŠ‚ï¼Ÿ
- [ ] **[P0]** å•å…ƒæµ‹è¯•ï¼ˆHooksï¼‰ï¼šè‡ªå®šä¹‰ Hooks æ˜¯å¦ä½¿ç”¨ `@testing-library/react` çš„ `renderHook`è¿›è¡Œæµ‹è¯•ï¼ŒéªŒè¯å…¶çŠ¶æ€é€»è¾‘å’Œå‰¯ä½œç”¨ï¼Ÿ
- [ ] **[P0]** å•å…ƒæµ‹è¯•ï¼ˆå·¥å…·å‡½æ•°ï¼‰ï¼šçº¯å‡½æ•°å’Œå·¥å…·å‡½æ•°æ˜¯å¦æœ‰ç®€æ´çš„å•å…ƒæµ‹è¯•æ¥éªŒè¯å…¶è¾“å…¥è¾“å‡ºï¼Ÿ

### æµ‹è¯•å®ç°ä¸è´¨é‡ [P1]
- [ ] **[P1]** é›†æˆæµ‹è¯•ï¼šç»„ä»¶é—´çš„äº¤äº’ï¼ˆå¦‚è¡¨å•æäº¤æµç¨‹ã€çˆ¶å­ç»„ä»¶é€šä¿¡ï¼‰æ˜¯å¦æœ‰é›†æˆæµ‹è¯•è¦†ç›–ï¼Ÿ
- [ ] **[P1]** æµ‹è¯•æè¿°æ¸…æ™°ï¼šæµ‹è¯•ç”¨ä¾‹çš„æè¿°ï¼ˆ`describe`, `it`ï¼‰æ˜¯å¦æ¸…æ™°ã€å‡†ç¡®åœ°è¡¨è¾¾äº†æµ‹è¯•çš„ç›®çš„å’Œåœºæ™¯ï¼Ÿ
- [ ] **[P1]** æ–­è¨€æ˜ç¡®ï¼šæµ‹è¯•æ–­è¨€ï¼ˆ`expect`ï¼‰æ˜¯å¦å…·ä½“ã€æœ‰æ„ä¹‰ï¼Œèƒ½å‡†ç¡®åæ˜ é¢„æœŸç»“æœï¼Ÿ
- [ ] **[P1]** é¿å…å†—ä½™æµ‹è¯•ï¼šæ˜¯å¦é¿å…äº†é‡å¤æˆ–ä¸å¿…è¦çš„æµ‹è¯•ç”¨ä¾‹ï¼Ÿ
- [ ] **[P1]** æµ‹è¯•ç‹¬ç«‹æ€§ï¼šæ¯ä¸ªæµ‹è¯•ç”¨ä¾‹æ˜¯å¦å¯ä»¥ç‹¬ç«‹è¿è¡Œï¼Œä¸ä¾èµ–äºå…¶ä»–æµ‹è¯•çš„æ‰§è¡Œé¡ºåºæˆ–çŠ¶æ€ï¼Ÿ
- [ ] **[P1]** Mocking ç­–ç•¥ï¼šå¯¹äºå¤–éƒ¨ä¾èµ–ï¼ˆAPI è¯·æ±‚ã€ç¬¬ä¸‰æ–¹åº“ã€å…¨å±€å¯¹è±¡ç­‰ï¼‰ï¼Œæ˜¯å¦ä½¿ç”¨äº† `vitest.mock` æˆ– `vi.spyOn` ç­‰æ°å½“çš„ Mocking æŠ€æœ¯è¿›è¡Œéš”ç¦»ï¼ŸMock æ˜¯å¦ä»…é’ˆå¯¹å¿…è¦éƒ¨åˆ†ï¼Œé¿å…è¿‡åº¦ Mockï¼Ÿ
- [ ] **[P1]** å¼‚æ­¥æµ‹è¯•å¤„ç†ï¼šæ¶‰åŠå¼‚æ­¥æ“ä½œçš„æµ‹è¯•ï¼ˆå¦‚ API è°ƒç”¨ã€å®šæ—¶å™¨ï¼‰æ˜¯å¦æ­£ç¡®ä½¿ç”¨äº† `async/await`ã€`waitFor`ã€`findBy*` ç­‰æœºåˆ¶ç­‰å¾…æ“ä½œå®Œæˆï¼Ÿ

### æµ‹è¯•ç¯å¢ƒä¸å·¥å…· [P0]
- [ ] **[P0]** æµ‹è¯•æ¡†æ¶é…ç½® (`vitest.config.ts`)ï¼š
    - æ˜¯å¦é…ç½®äº† `jsdom` ä½œä¸ºæµ‹è¯•ç¯å¢ƒï¼Ÿ
    - æ˜¯å¦æŒ‡å®šäº† `setupFiles` æ¥å¤„ç†å…¨å±€æµ‹è¯•è®¾ç½®ï¼ˆå¦‚å¯¼å…¥ `@testing-library/jest-dom`ï¼‰ï¼Ÿ
    - æ˜¯å¦å¯ç”¨äº†æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š (`coverage.provider`) å¹¶è®¾ç½®äº†åˆç†çš„é˜ˆå€¼ (`thresholds`)ï¼Ÿ
- [ ] **[P0]** æµ‹è¯•å¯åŠ¨ä¸è¿è¡Œï¼šæµ‹è¯•æ˜¯å¦å¯ä»¥æ–¹ä¾¿åœ°åœ¨æœ¬åœ°é€šè¿‡ npm scripts (å¦‚ `npm test` æˆ– `npm run test:coverage`) è¿è¡Œï¼Ÿ

### E2E æµ‹è¯• (è‹¥é€‚ç”¨) [P1]
- [ ] **[P1]** E2E æµ‹è¯•æ¡†æ¶ï¼šå¦‚æœé¡¹ç›®åŒ…å« E2E æµ‹è¯•ï¼Œæ˜¯å¦ä½¿ç”¨äº† `Playwright`ï¼ˆæˆ–ç±»ä¼¼æ¡†æ¶å¦‚ Cypressï¼‰ï¼Ÿ
- [ ] **[P1]** E2E æµ‹è¯•æµç¨‹ï¼šE2E æµ‹è¯•æ˜¯å¦è¦†ç›–äº†å…³é”®çš„ç”¨æˆ·åœºæ™¯å’Œç«¯åˆ°ç«¯æµç¨‹ï¼Ÿ
- [ ] **[P1]** E2E æµ‹è¯•ç¨³å®šæ€§ï¼šE2E æµ‹è¯•æ˜¯å¦ç›¸å¯¹ç¨³å®šï¼Œé¿å…äº†å› ç»†å¾® UI å˜åŠ¨æˆ–ç½‘ç»œæ³¢åŠ¨å¯¼è‡´çš„é¢‘ç¹å¤±è´¥ï¼Ÿï¼ˆå¦‚ä½¿ç”¨ç¨³å®šçš„é€‰æ‹©å™¨ã€é€‚å½“çš„ç­‰å¾…æœºåˆ¶ï¼‰

### CI ä¸è‡ªåŠ¨åŒ– [P2]
- [ ] **[P2]** CI é›†æˆï¼šæµ‹è¯•ï¼ˆå•å…ƒã€é›†æˆã€E2Eï¼‰æ˜¯å¦å·²é›†æˆåˆ°æŒç»­é›†æˆï¼ˆCIï¼‰æµç¨‹ä¸­ï¼Œåœ¨æ¯æ¬¡ä»£ç æäº¤æˆ–åˆå¹¶è¯·æ±‚æ—¶è‡ªåŠ¨è¿è¡Œï¼Ÿ
- [ ] **[P2]** æµ‹è¯•æŠ¥å‘Šï¼šCI æµç¨‹æ˜¯å¦ä¼šç”Ÿæˆå¹¶å±•ç¤ºæ¸…æ™°çš„æµ‹è¯•ç»“æœæŠ¥å‘Šå’Œè¦†ç›–ç‡æŠ¥å‘Šï¼Ÿ
