---
description: 
globs: 
alwaysApply: false
---
# å®‰å…¨è§„èŒƒ

## æ ¸å¿ƒåŸåˆ™ [P0]

ã€å¿…é¡»ã€‘éµå¾ªï¼š
- éªŒè¯æ‰€æœ‰ç”¨æˆ·è¾“å…¥
- é˜²æ­¢ XSS å’Œ CSRF æ”»å‡»
- å®‰å…¨å¤„ç†æ•æ„Ÿæ•°æ®
- å®ç°å®‰å…¨çš„è®¤è¯æœºåˆ¶

## è¾“å…¥éªŒè¯

ã€å¿…é¡»ã€‘éªŒè¯æ‰€æœ‰ç”¨æˆ·è¾“å…¥ï¼š

```tsx
import { z } from 'zod';

// âœ… æ­£ç¡® - ä½¿ç”¨ Zod éªŒè¯
const UserInputSchema = z.object({
  name: z.string().min(1).max(100).regex(/^[a-zA-Z\s]+$/),
  email: z.string().email(),
  age: z.number().int().min(0).max(150),
  website: z.string().url().optional(),
});

function validateUserInput(input: unknown) {
  try {
    return UserInputSchema.parse(input);
  } catch (error) {
    throw new Error('è¾“å…¥éªŒè¯å¤±è´¥');
  }
}

// âœ… æ­£ç¡® - è¡¨å•éªŒè¯
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';

function UserForm() {
  const form = useForm({
    resolver: zodResolver(UserInputSchema),
  });

  const onSubmit = (data: z.infer<typeof UserInputSchema>) => {
    // æ•°æ®å·²éªŒè¯ï¼Œå¯å®‰å…¨ä½¿ç”¨
    submitUser(data);
  };

  return (
    <form onSubmit={form.handleSubmit(onSubmit)}>
      <input {...form.register('name')} placeholder="å§“å" />
      <input {...form.register('email')} type="email" placeholder="é‚®ç®±" />
      <button type="submit">æäº¤</button>
    </form>
  );
}

// âŒ é”™è¯¯ - æœªéªŒè¯è¾“å…¥
function badSubmit(data: any) {
  fetch('/api/users', {
    method: 'POST',
    body: JSON.stringify(data), // å±é™©ï¼æœªéªŒè¯
  });
}
```

## XSS é˜²æŠ¤

ã€å¿…é¡»ã€‘é˜²æ­¢è·¨ç«™è„šæœ¬æ”»å‡»ï¼š

```tsx
import DOMPurify from 'dompurify';

// âœ… æ­£ç¡® - React è‡ªåŠ¨è½¬ä¹‰
function SafeComponent({ userContent }: { userContent: string }) {
  return (
    <div>
      {/* React è‡ªåŠ¨è½¬ä¹‰ï¼Œå®‰å…¨ */}
      <p>{userContent}</p>
      
      {/* å¦‚éœ€æ’å…¥ HTMLï¼Œä½¿ç”¨ DOMPurify æ¸…ç† */}
      <div 
        dangerouslySetInnerHTML={{
          __html: DOMPurify.sanitize(userContent)
        }}
      />
    </div>
  );
}

// âœ… æ­£ç¡® - å†…å®¹å®‰å…¨ç­–ç•¥ (CSP)
// åœ¨ Next.js ä¸­é…ç½®
const nextConfig = {
  async headers() {
    return [
      {
        source: '/(.*)',
        headers: [
          {
            key: 'Content-Security-Policy',
            value: "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline';"
          },
        ],
      },
    ];
  },
};

// âŒ é”™è¯¯ - ç›´æ¥æ’å…¥ç”¨æˆ·å†…å®¹
function DangerousComponent({ userContent }: { userContent: string }) {
  return (
    <div 
      dangerouslySetInnerHTML={{ __html: userContent }} // å±é™©ï¼
    />
  );
}
```

## CSRF é˜²æŠ¤

ã€å¿…é¡»ã€‘é˜²æ­¢è·¨ç«™è¯·æ±‚ä¼ªé€ ï¼š

```tsx
// âœ… æ­£ç¡® - API è¯·æ±‚æ·»åŠ  CSRF ä¿æŠ¤
const api = axios.create({
  baseURL: '/api',
  headers: {
    'X-Requested-With': 'XMLHttpRequest',
  },
});

// æ·»åŠ  CSRF token
api.interceptors.request.use((config) => {
  const token = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
  if (token) {
    config.headers['X-CSRF-Token'] = token;
  }
  return config;
});

// âœ… æ­£ç¡® - SameSite Cookie è®¾ç½®
// æœåŠ¡ç«¯é…ç½®
app.use(session({
  cookie: {
    sameSite: 'strict',
    secure: true, // HTTPS ç¯å¢ƒ
    httpOnly: true,
  }
}));
```

## æ•æ„Ÿæ•°æ®å¤„ç†

ã€å¿…é¡»ã€‘å®‰å…¨å¤„ç†æ•æ„Ÿä¿¡æ¯ï¼š

```tsx
// âœ… æ­£ç¡® - ç¯å¢ƒå˜é‡ç®¡ç†
// .env.local (ä¸æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶)
NEXT_PUBLIC_API_URL=https://api.example.com
DATABASE_URL=postgresql://...
JWT_SECRET=your-secret-key

// âœ… æ­£ç¡® - å®‰å…¨çš„è®¤è¯çŠ¶æ€ç®¡ç†
function useAuth() {
  const [user, setUser] = useState<User | null>(null);

  const login = async (credentials: LoginCredentials) => {
    const response = await fetch('/api/auth/login', {
      method: 'POST',
      credentials: 'include', // ä½¿ç”¨ httpOnly cookie
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(credentials),
    });
    
    if (response.ok) {
      const userData = await response.json();
      setUser(userData);
    }
  };

  const logout = async () => {
    await fetch('/api/auth/logout', {
      method: 'POST',
      credentials: 'include',
    });
    setUser(null);
  };

  return { user, login, logout };
}

// âœ… æ­£ç¡® - å¯†ç è¾“å…¥å¤„ç†
function PasswordInput() {
  const [password, setPassword] = useState('');
  
  const handleSubmit = (e: FormEvent) => {
    e.preventDefault();
    submitPassword(password);
    setPassword(''); // æäº¤åç«‹å³æ¸…ç†
  };

  return (
    <input
      type="password"
      value={password}
      onChange={(e) => setPassword(e.target.value)}
      autoComplete="current-password"
    />
  );
}

// âŒ é”™è¯¯ - æ•æ„Ÿæ•°æ®å­˜å‚¨
localStorage.setItem('token', jwtToken); // å±é™©ï¼
console.log('Password:', password); // å±é™©ï¼
```

## API å®‰å…¨

ã€å¿…é¡»ã€‘ç¡®ä¿ API è°ƒç”¨å®‰å…¨ï¼š

```tsx
// âœ… æ­£ç¡® - å®‰å…¨çš„ API å®¢æˆ·ç«¯
const secureApi = axios.create({
  baseURL: process.env.NEXT_PUBLIC_API_URL,
  timeout: 10000,
  headers: {
    'Content-Type': 'application/json',
  },
});

// è¯·æ±‚æ‹¦æˆªå™¨
secureApi.interceptors.request.use((config) => {
  const token = getAuthToken();
  if (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }
  return config;
});

// å“åº”æ‹¦æˆªå™¨
secureApi.interceptors.response.use(
  (response) => response,
  (error) => {
    if (error.response?.status === 401) {
      redirectToLogin();
    }
    return Promise.reject(error);
  }
);

// âœ… æ­£ç¡® - åŸºç¡€é€Ÿç‡é™åˆ¶
const requestCounts = new Map<string, number>();

function rateLimit(key: string, maxRequests: number, windowMs: number) {
  const now = Date.now();
  const count = requestCounts.get(key) || 0;
  
  if (count >= maxRequests) {
    throw new Error('Too many requests');
  }
  
  requestCounts.set(key, count + 1);
  
  setTimeout(() => {
    requestCounts.delete(key);
  }, windowMs);
}
```

## è·¯ç”±ä¿æŠ¤

ã€å¿…é¡»ã€‘ä¿æŠ¤æ•æ„Ÿè·¯ç”±ï¼š

```tsx
// âœ… æ­£ç¡® - è·¯ç”±ä¿æŠ¤ç»„ä»¶
function ProtectedRoute({ children, requiredRole }: {
  children: React.ReactNode;
  requiredRole?: string;
}) {
  const { user } = useAuth();
  
  if (!user) {
    return <Navigate to="/login" replace />;
  }
  
  if (requiredRole && user.role !== requiredRole) {
    return <div>æƒé™ä¸è¶³</div>;
  }
  
  return <>{children}</>;
}

// âœ… ä½¿ç”¨ç¤ºä¾‹
function App() {
  return (
    <Routes>
      <Route path="/login" element={<LoginPage />} />
      <Route path="/dashboard" element={
        <ProtectedRoute>
          <Dashboard />
        </ProtectedRoute>
      } />
      <Route path="/admin" element={
        <ProtectedRoute requiredRole="admin">
          <AdminPanel />
        </ProtectedRoute>
      } />
    </Routes>
  );
}
```

## ä¾èµ–å®‰å…¨

ã€æ¨èã€‘å®šæœŸæ£€æŸ¥ä¾èµ–å®‰å…¨ï¼š

```json
// package.json å®‰å…¨è„šæœ¬
{
  "scripts": {
    "audit": "npm audit",
    "audit:fix": "npm audit fix",
    "security:check": "npm audit --audit-level=moderate"
  }
}
```

## å®‰å…¨å¤´é…ç½®

ã€å¿…é¡»ã€‘è®¾ç½®å®‰å…¨å“åº”å¤´ï¼š

```tsx
// âœ… æ­£ç¡® - Next.js å®‰å…¨å¤´é…ç½®
const nextConfig = {
  async headers() {
    return [
      {
        source: '/(.*)',
        headers: [
          {
            key: 'X-Content-Type-Options',
            value: 'nosniff'
          },
          {
            key: 'X-Frame-Options',
            value: 'DENY'
          },
          {
            key: 'X-XSS-Protection',
            value: '1; mode=block'
          },
          {
            key: 'Strict-Transport-Security',
            value: 'max-age=31536000; includeSubDomains'
          }
        ],
      },
    ];
  },
};
```

## ğŸ” æ£€æŸ¥æ¸…å•

åœ¨å¼€å‘å’Œå®¡æŸ¥ä»£ç çš„å®‰å…¨æ€§æ—¶ï¼Œè¯·å¯¹ç…§ä»¥ä¸‹æ£€æŸ¥é¡¹ï¼š

### æ ¸å¿ƒé˜²æŠ¤ä¸æ•°æ®å¤„ç† [P0]
- [ ] **[P0]** è¾“å…¥éªŒè¯ï¼šæ‰€æœ‰æ¥è‡ªå¤–éƒ¨ï¼ˆç”¨æˆ·ã€APIå“åº”ã€URLå‚æ•°ç­‰ï¼‰çš„è¾“å…¥æ•°æ®æ˜¯å¦éƒ½é€šè¿‡ Zod æˆ–ç±»ä¼¼åº“è¿›è¡Œäº†ä¸¥æ ¼çš„æ ¼å¼ã€ç±»å‹å’ŒèŒƒå›´éªŒè¯ï¼Ÿ
- [ ] **[P0]** XSS é˜²æŠ¤ï¼š
    - åœ¨ React ä¸­æ¸²æŸ“ç”¨æˆ·å†…å®¹æ—¶ï¼Œæ˜¯å¦ä¾èµ–å…¶é»˜è®¤çš„è½¬ä¹‰æœºåˆ¶ï¼Ÿ
    - è‹¥å¿…é¡»ä½¿ç”¨ `dangerouslySetInnerHTML`ï¼Œå…¶å†…å®¹æ˜¯å¦ç»è¿‡äº† `DOMPurify.sanitize()` æˆ–ç­‰æ•ˆåº“çš„ä¸¥æ ¼å‡€åŒ–ï¼Ÿ
- [ ] **[P0]** CSRF é˜²æŠ¤ï¼š
    - API è¯·æ±‚ï¼ˆç‰¹åˆ«æ˜¯æ‰§è¡ŒçŠ¶æ€å˜æ›´çš„æ“ä½œï¼‰æ˜¯å¦åŒ…å«äº† CSRF Token æˆ–å…¶ä»–æœ‰æ•ˆçš„ CSRF é˜²æŠ¤æœºåˆ¶ï¼ˆå¦‚ `X-Requested-With` header æ ¡éªŒï¼ŒSameSite Cookie å±æ€§ï¼‰ï¼Ÿ
    - Session Cookie æ˜¯å¦é…ç½®äº† `SameSite=Strict` (æˆ– `Lax`ï¼Œæ ¹æ®éœ€æ±‚) å’Œ `HttpOnly` å±æ€§ï¼Ÿ
- [ ] **[P0]** æ•æ„Ÿæ•°æ®å¤„ç†ï¼š
    - æ•æ„Ÿå¯†é’¥ã€API Tokensã€æ•°æ®åº“å‡­è¯ç­‰æ˜¯å¦ä»ä¸ç¡¬ç¼–ç åœ¨å‰ç«¯ä»£ç ä¸­ï¼Œè€Œæ˜¯é€šè¿‡ç¯å¢ƒå˜é‡ï¼ˆå¦‚ `.env.local`ï¼Œä¸”ä¸æäº¤åˆ°ç‰ˆæœ¬åº“ï¼‰ç®¡ç†ï¼Œå¹¶é€šè¿‡åç«¯ä¼ é€’ç»™å‰ç«¯ï¼ˆå¦‚æœå¿…è¦ä¸”å®‰å…¨çš„è¯ï¼‰ï¼Ÿ
    - æ˜¯å¦é¿å…åœ¨ `localStorage` æˆ– `sessionStorage` ä¸­å­˜å‚¨é«˜åº¦æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚ JWT tokensï¼Œé™¤éæœ‰ç‰¹å®šå®‰å…¨æªæ–½ï¼‰ï¼Ÿ
    - å¯†ç ç­‰æ•æ„Ÿä¿¡æ¯åœ¨è¡¨å•æäº¤åæ˜¯å¦ç«‹å³ä»å†…å­˜ä¸­æ¸…é™¤ï¼Ÿ
- [ ] **[P0]** API å®‰å…¨ï¼š
    - API å®¢æˆ·ç«¯ï¼ˆå¦‚ Axios å®ä¾‹ï¼‰æ˜¯å¦é…ç½®äº†è¶…æ—¶å’Œå¿…è¦çš„å®‰å…¨å¤´éƒ¨ï¼ˆå¦‚ `Content-Type`ï¼‰ï¼Ÿ
    - API è¯·æ±‚æ˜¯å¦åœ¨æ‹¦æˆªå™¨ä¸­ç»Ÿä¸€æ·»åŠ äº†è®¤è¯å‡­è¯ï¼ˆå¦‚ Bearer Tokenï¼‰ï¼Ÿ
    - API å“åº”æ‹¦æˆªå™¨æ˜¯å¦å¤„ç†äº†å¸¸è§çš„è®¤è¯é”™è¯¯ï¼ˆå¦‚ 401 è‡ªåŠ¨è·³è½¬ç™»å½•ï¼‰ï¼Ÿ

### é‡è¦å®‰å…¨æªæ–½ [P1]
- [ ] **[P1]** è®¤è¯ä¸æˆæƒï¼šæ‰€æœ‰éœ€è¦ä¿æŠ¤çš„èµ„æºå’Œæ“ä½œæ˜¯å¦éƒ½æœ‰å¥å…¨çš„è®¤è¯ï¼ˆç”¨æˆ·æ˜¯è°ï¼‰å’Œæˆæƒï¼ˆç”¨æˆ·èƒ½åšä»€ä¹ˆï¼‰æ£€æŸ¥ï¼Ÿ
- [ ] **[P1]** ä¾èµ–å®‰å…¨ï¼šæ˜¯å¦å®šæœŸï¼ˆå¦‚ CI/CD æµç¨‹ä¸­æˆ–æ‰‹åŠ¨ï¼‰ä½¿ç”¨ `npm audit`, `pnpm audit` æˆ– Snyk ç­‰å·¥å…·æ£€æŸ¥é¡¹ç›®ä¾èµ–çš„å·²çŸ¥æ¼æ´ï¼Œå¹¶åŠæ—¶æ›´æ–°æˆ–æ›¿æ¢æœ‰é£é™©çš„åŒ…ï¼Ÿ
- [ ] **[P1]** HTTPS å¼ºåˆ¶ï¼šç”Ÿäº§ç¯å¢ƒåº”ç”¨æ˜¯å¦å…¨ç«™å¯ç”¨äº† HTTPSï¼Œå¹¶ç¡®ä¿æ‰€æœ‰èµ„æºé€šè¿‡ HTTPS åŠ è½½ï¼Ÿï¼ˆé€šè¿‡ HSTS å¤´å¢å¼ºï¼‰
- [ ] **[P1]** å®‰å…¨æ—¥å¿—ï¼šå¯¹äºå…³é”®çš„å®‰å…¨äº‹ä»¶ï¼ˆå¦‚ç™»å½•å¤±è´¥ã€æƒé™æ‹’ç»ã€å¯ç–‘æ“ä½œï¼‰ï¼Œæ˜¯å¦æœ‰é€‚å½“çš„æ—¥å¿—è®°å½•æœºåˆ¶ï¼Ÿ

### è¿›é˜¶ä¸å¯é€‰å¢å¼º [P2]
- [ ] **[P2]** å†…å®¹å®‰å…¨ç­–ç•¥ (CSP)ï¼šæ˜¯å¦ä¸ºåº”ç”¨é…ç½®äº†åˆç†çš„ CSP HTTP å¤´éƒ¨ï¼Œä»¥é™åˆ¶æµè§ˆå™¨å¯åŠ è½½å’Œæ‰§è¡Œçš„èµ„æºï¼Œå‡å°‘ XSS å’Œæ•°æ®æ³¨å…¥é£é™©ï¼Ÿ
- [ ] **[P2]** å®‰å…¨ HTTP å¤´éƒ¨ï¼šæ˜¯å¦ä½¿ç”¨äº†å¦‚ `helmet` (Node.js) æˆ–ç­‰æ•ˆæœºåˆ¶æ¥è®¾ç½®å…¶ä»–é‡è¦çš„å®‰å…¨ç›¸å…³ HTTP å¤´éƒ¨ï¼ˆå¦‚ `X-Frame-Options`, `X-Content-Type-Options`, `Referrer-Policy`ï¼‰ï¼Ÿ
- [ ] **[P2]** å®šæœŸå®‰å…¨å®¡è®¡ï¼šæ˜¯å¦è®¡åˆ’æˆ–å®šæœŸå¯¹ä»£ç åº“è¿›è¡Œä¸“é—¨çš„å®‰å…¨å®¡è®¡ï¼ˆå†…éƒ¨æˆ–ç¬¬ä¸‰æ–¹ï¼‰ï¼Ÿ
- [ ] **[P2]** é€Ÿç‡é™åˆ¶ä¸é˜²æ»¥ç”¨ï¼šAPI ç«¯ç‚¹å’Œæ•æ„Ÿæ“ä½œï¼ˆå¦‚ç™»å½•ã€æ³¨å†Œï¼‰æ˜¯å¦å®æ–½äº†é€Ÿç‡é™åˆ¶ä»¥é˜²æ­¢æš´åŠ›ç ´è§£å’Œæ»¥ç”¨ï¼Ÿ
